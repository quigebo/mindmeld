MindMeld Brownfield Enhancement PRD
Author: John (Product Manager)
Version: 0.1
Date: August 17, 2025

1. Intro, Project Analysis, and Context
1.1 Existing Project Overview
This PRD outlines an enhancement to the existing MindMeld application. The current state of the application's architecture, technology stack, and coding patterns are documented in the MindMeld Brownfield Architecture Document (generated by Winston, the Architect). All development for this enhancement must adhere to the principles and patterns outlined in that document.

1.2 Enhancement Scope Definition
Enhancement Type: New Feature Addition.

Impact Assessment: Moderate Impact (new services, UI changes, integration with existing models).

Enhancement Description: This feature, titled "Dynamic Story Theming & Contextual Enrichment," will automatically personalize the visual appearance of a story based on its content. It aims to create a more immersive and "magical" experience by using key entities from user memories to fetch and display relevant background images and icons, and by interactively asking questions to enrich the story's context.

2. Goals and Requirements
2.1 Goals
To increase user engagement by making the storytelling experience more visually immersive and personalized.

To create moments of "magic" by proactively understanding the story's context and reflecting it in the UI.

To establish a foundational system for further AI-driven contextual enhancements.

2.2 Functional Requirements (FR)
FR1: The system must provide a setting for each story to enable or disable the Dynamic Theming feature.

FR2: When enabled, the system must analyze the story's comments to extract key entities (e.g., locations, events) suitable for theming.

FR3: The system must use the primary theme entity to automatically source and apply a relevant background image to the story view.

FR4: The system may use secondary theme entities to display relevant custom icons within the story UI.

FR5: During the story creation flow, if the feature is enabled, the system must present a series of goal-oriented questions to the user to establish the story's core structure (e.g., beginning, middle, end).

2.3 Compatibility Requirements (CR)
CR1: The Dynamic Theming feature must not interfere with the core functionality of creating, viewing, and adding comments to a story.

CR2: Existing stories created before this feature will have Dynamic Theming disabled by default.

CR3: The addition of a background image must not compromise the legibility of the story's text content.

3. Epic and Story Structure
This enhancement will be delivered within a single epic for the Minimum Viable Product (MVP).

Epic 1: Dynamic Story Theming (MVP)
Goal: To introduce an automated visual theming engine that personalizes stories with a background image and icons, and to implement a goal-oriented Q&A flow during story creation to establish a narrative structure.

User Stories:

Story 1.1: Theming Control

As a story creator, I want to enable or disable the "Dynamic Theming" feature for each story, so that I have control over the visual presentation.

Acceptance Criteria:

A toggle/checkbox is present in the "new story" and "edit story" forms.

The setting is saved and respected when viewing the story.

The setting defaults to "enabled" for new stories.

Story 1.2: Automatic Background Image

As a participant in a story, I want the story's background image to automatically reflect its main theme (e.g., a location or event), so that the experience feels immersive.

Acceptance Criteria:

When a story is viewed and theming is enabled, the system identifies the primary entity.

An external API is queried to find a relevant, commercially-usable image.

The fetched image is displayed as the background for the story page.

A subtle loading state is shown while the image is being fetched.

If no image can be found, a default background is used.

Story 1.3: Narrative Structure Q&A

As a story creator, I want the app to ask me a few key questions when I start a new story, so that I can easily establish its basic beginning, middle, and end.

Acceptance Criteria:

During the "new story" flow, after the title is entered, the user is prompted with a series of questions.

The questions are designed to elicit the main points of the narrative arc.

The user's answers are saved as the initial comments in the story.

These comments are then used as the primary source for the initial background image selection.

MindMeld Brownfield Enhancement Architecture
Author: Winston (Architect)
Version: 1.0
Date: August 17, 2025
Related PRD: Brownfield PRD for Dynamic Story Theming v0.1

1. Introduction
This document provides the technical architecture for the "Dynamic Story Theming & Contextual Enrichment" feature. The design prioritizes seamless integration with the existing Ruby on Rails / Hotwire application, leveraging current patterns while introducing new services in a modular and maintainable way.

2. Enhancement Scope and Integration Strategy
2.1 Integration Approach
The new feature will be integrated into the existing application following these principles:

Code Integration: All new logic will be encapsulated within a new Theming module (app/services/theming/) to ensure clear separation from existing business logic.

Database Integration: A new story_themes table will be created to store theming data for each story, avoiding modifications to existing tables.

UI Integration: The feature will use Hotwire (Turbo Streams) to dynamically update the story's background and icons in real-time as new, theme-worthy comments are added.

Asynchronous Processing: All external API calls for image fetching and analysis will be performed in the background using ActiveJob to avoid blocking user requests.

3. Tech Stack Alignment
3.1 Existing Technology Stack
The enhancement will be built using the project's existing technology stack: Ruby on Rails and Hotwire.

3.2 New Technology Additions
Technology	Purpose	Rationale
Unsplash API (or similar)	Image Sourcing	To programmatically find high-quality, commercially-usable background images based on story content. A free tier is suitable for the MVP.

Export to Sheets
4. Data Models and Schema Changes
A new model and corresponding database table will be created to manage theming.

New Model: StoryTheme
Ruby

# app/models/story_theme.rb
class StoryTheme < ApplicationRecord
  belongs_to :story
  belongs_to :source_entity, class_name: 'Entity'

  validates :story, uniqueness: true
end
Schema Migration
A migration will be created to add the story_themes table:

Ruby

create_table :story_themes do |t|
  t.references :story, null: false, foreign_key: true, index: { unique: true }
  t.references :source_entity, null: false, foreign_key: { to_table: :entities }
  t.string :background_image_url
  t.string :icon_pack
  t.jsonb :metadata # For storing API responses, etc.
  t.timestamps
end
5. Component Architecture
The feature will be composed of several new service objects and a background job.

New Service Components
Theming::ThemeIdentifierService: Analyzes entities from a new comment to determine if a new theme should be applied.

Theming::ImageProviderService: Takes a theme entity (e.g., "Lollapalooza") and fetches a relevant image URL from the Unsplash API.

Theming::InquiryService: Manages the logic for the goal-oriented Q&A during the story creation flow.

Component Interaction Diagram
Code snippet

sequenceDiagram
    participant User
    participant Browser
    participant Rails App
    participant ActiveJob
    participant Theme Services
    participant Image API

    User->>Browser: Submits new comment
    Browser->>Rails App: POST /stories/1/comments
    Rails App-->>Browser: Turbo Stream (Append comment)
    Rails App->>ActiveJob: Enqueue ThemeAnalysisJob
    ActiveJob->>Theme Services: IdentifyTheme()
    Theme Services->>Image API: FetchImage()
    Image API-->>Theme Services: Image URL
    Theme Services->>Rails App: Update StoryTheme record
    Rails App->>Browser: Broadcast Turbo Stream (Update Background)
6. Source Tree Integration
New files will be organized to maintain separation of concerns:

Plaintext

app/
├── jobs/
│   └── theming/
│       └── theme_analysis_job.rb
├── models/
│   └── story_theme.rb
├── services/
│   └── theming/
│       ├── image_provider_service.rb
│       ├── inquiry_service.rb
│       └── theme_identifier_service.rb
└── views/
    └── stories/
        └── _theme.html.erb
7. Testing Strategy
Unit Tests: Each new service will be unit-tested in isolation. The external image API will be mocked.

Integration Tests: The Comment model will be tested to ensure the ThemeAnalysisJob is correctly enqueued on create.

System Tests: A full-browser system test will verify that creating a comment with a theme-worthy entity results in the background image of the page being updated via Turbo Streams.